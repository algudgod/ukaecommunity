<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8">
    <title>내 정보 보기</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body>

<!-- 내 정보 보기 -->
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <h2 class="text-center mb-2 fw-bold">
                <span th:text="${user.loginId}"></span>님의 정보
            </h2>
            <p class="text-center text-muted">
                <span th:text="${user.email}"></span>
            </p>

            <!-- 카드 형태로 사용자 정보 -->
            <div class="card mx-auto rounded" style="width: 100%; max-width: 500px;">
                <div class="card-body">

                    <!-- 프로필 사진 -->
                    <div class="d-flex justify-content-center mt-1 mb-2">
                        <div class="position-relative">
                            <img id="profileImagePreview"
                                 th:src="${user.profileUrl}"
                                 alt="프로필 사진" class="rounded-circle"
                                 style="width: 130px; height: 130px; border: 1px solid #ccc;">

                            <!-- 연필 버튼 -->
                            <button id="editProfileButton"
                                    class="btn btn-light position-absolute bottom-0 end-0"
                                    style="border: 1px solid #ccc; padding: 5px; border-radius: 50%;">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <input type="file" id="profileImageInput" name="file" accept="image/*"
                                   style="display: none;" onchange="previewProfileImage(event); uploadProfileImage(event);">
                        </div>
                    </div>

                    <!-- 구분선 -->
                    <div class="d-flex justify-content-center">
                        <hr style="width: 100%; border: 1px solid #ccc;">
                    </div>

                    <!-- 닉네임 -->
                    <div class="mb-3 row">
                        <label class="col-4 col-form-label text-end"><strong>닉네임:</strong></label>
                        <div class="col-8 mt-2">
                            <span th:text="${user.nickname}"></span>
                        </div>
                    </div>

                    <!-- 성별 -->
                    <div class="mb-3 row">
                        <label class="col-4 col-form-label text-end"><strong>성별:</strong></label>
                        <div class="col-8 mt-2">
                            <span th:text="${user.gender == 'M' ? '남성' : '여성'}"></span>
                        </div>
                    </div>

                    <!-- 전화번호 -->
                    <div class="mb-3 row">
                        <label class="col-4 col-form-label text-end"><strong>전화번호:</strong></label>
                        <div class="col-8 mt-2">
                            <span th:text="${user.formattedPhone}"></span>
                        </div>
                    </div>

                    <!-- 주소 -->
                    <div class="mb-3 row">
                        <label class="col-4 col-form-label text-end"><strong>주소:</strong></label>
                        <div class="col-8 mt-2">
                            <span th:text="${user.address}"></span>
                        </div>
                    </div>

                    <!-- 가입일 -->
                    <div class="mb-1 row">
                        <label class="col-4 col-form-label text-end"><strong>가입일:</strong></label>
                        <div class="col-8 mt-2">
                            <span th:text="${#temporals.format(user.createDate, 'yyyy년 MM월 dd일')}"></span>
                        </div>
                    </div>
                </div>

                <!-- 탈퇴하기 -->
                <div class="right-align-form pe-2" style="text-align: right;">
                    <form th:action="@{/user/deleteUser}" method="post" onsubmit="return confirm('정말 탈퇴하시겠습니까?');">
                        <button type="submit" class="btn btn-link" style="color: gray; font-size: 0.9rem;">탈퇴하기</button>
                    </form>
                </div>

                <!-- 구분선 -->
                <div class="d-flex justify-content-center">
                    <hr style="width: 100%; border: 1px solid #ccc;">
                </div>

                <!-- 버튼 영역 -->
                <div class="card-footer d-flex justify-content-between gap-3 bg-white border-0">
                    <a th:href="@{/}" class="btn btn-outline-dark w-50">홈으로</a>
                    <a th:href="@{/user/editUserForm}" class="btn btn-dark w-50">정보 수정</a>
                </div>

            </div>
        </div>
    </div>
</div>


<script>

    // 회원 프로필 사진 옆 연필 버튼 클릭 시, file 업로드 창 띄움
    document.getElementById('editProfileButton').addEventListener('click', function () {
        document.getElementById('profileImageInput').click();
    });

    function previewProfileImage(event) {
        const file = event.target.files[0]; // 선택된 파일
        if (file) {
            const reader = new FileReader(); // FileReader 객체 생성
            reader.onload = function(e) {
                const previewImage = document.getElementById('profileImagePreview');
                previewImage.src = e.target.result; // 미리보기 이미지 업데이트
            };
            reader.readAsDataURL(file); // 파일 내용을 읽고 Base64 데이터 URL 생성
        }
    }

function uploadProfileImage(event) {
    const file = event.target.files[0]; // 선택된 파일
    if (file) {
        const formData = new FormData();
        formData.append("file", file); // 서버에 보낼 파일

        fetch('/api/s3/profileUpload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.text(); // 업로드된 URL 반환
            } else {
                throw new Error("업로드 실패");
            }
        })
        .then(fileUrl => {
            console.log("Returned fileUrl:", fileUrl); // 서버에서 반환된 URL 출력
            alert("프로필 사진이 성공적으로 업로드되었습니다!");
        })
        .catch(error => {
            console.error("업로드 에러: ", error);
            alert("업로드 중 문제가 발생했습니다.");
        });
    }
}
</script>
</body>
</html>
