<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œíŒ</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/styles.css}">

    <style>

        .mb-4 {
            min-height: 300px; /* ìµœì†Œ ë†’ì´ ì„¤ì • */
            overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ì„¸ë¡œ ìŠ¤í¬ë¡¤ ì¶”ê°€ */
            word-wrap: break-word; /* ê¸´ ë‹¨ì–´ë¥¼ ìë™ìœ¼ë¡œ ì¤„ ë°”ê¿ˆ */
            padding: 10px; /* ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
        }

        .form-control {
                resize: none; /* ì‚¬ìš©ìê°€ í¬ê¸° ì¡°ì • ëª»í•˜ê²Œ ê³ ì • */
                height: 95px; /* ì…ë ¥ ì°½ ë†’ì´ ì„¤ì • */
                font-size: 0.9rem; /* í…ìŠ¤íŠ¸ í¬ê¸° */
            }

            .comment-item {
                margin-bottom: 1.2rem; /* ëŒ“ê¸€ ê°„ ê°„ê²©ì„ ë„“í˜ */
            }
            .comment-item .comment-header p strong {
                font-size: 0.9rem; /* ë‹‰ë„¤ì„ í¬ê¸° */
                font-weight: 800; /* ì¤‘ê°„ êµµê¸° */
            }
            .comment-item .comment-body p {
                font-size: 0.9rem; /* ë‚´ìš© í¬ê¸° */
                margin-top: 0.2rem;/* ë‹‰ë„¤ì„ê³¼ ë‚´ìš© ì‚¬ì´ ê°„ê²© ì¶”ê°€ */
            }
            .comment-item .comment-header p {
                margin: 0; /* ê¸°ë³¸ ì—¬ë°± ì œê±° */
            }

            /* Flexboxë¥¼ ì‚¬ìš©í•˜ì—¬ í•œ ì¤„ì— ë°°ì¹˜ */
            .comment-content-row {
                display: flex;
                justify-content: space-between; /* ë‚´ìš©ê³¼ ë²„íŠ¼ ê·¸ë£¹ ê°„ê²© ì¡°ì • */
                align-items: center; /* ì„¸ë¡œ ê°€ìš´ë° ì •ë ¬ */
            }

            .comment-content {
                margin: 0; /* ê¸°ë³¸ ì—¬ë°± ì œê±° */
                flex: 1; /* ë²„íŠ¼ ì œì™¸í•˜ê³  ë‚˜ë¨¸ì§€ ê³µê°„ ì°¨ì§€ */
            }

            .comment-actions {
                display: flex;
                gap: 10px; /* ë²„íŠ¼ ê°„ê²© */
            }

            .form-control {
            border: 1px solid #ccc; /* ê¸°ë³¸ í…Œë‘ë¦¬ ìƒ‰ */
            border-radius: 4px; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            outline: none; /* ê¸°ë³¸ outline ì œê±° */
            }

            /* textarea í¬ì»¤ìŠ¤ ìƒíƒœ */
            .form-control:focus {
                border: 1px solid #333; /* í…Œë‘ë¦¬ë¥¼ ì–‡ì€ ê²€ì •ìœ¼ë¡œ ì„¤ì • */
                box-shadow: none; /* íŒŒë€ìƒ‰ ê·¸ë¦¼ì ì œê±° */
            }
            .comment-actions .btn-sm {
            padding: 2px 6px; /* íŒ¨ë”© ì¤„ì´ê¸° */
            font-size: 12px; /* ê¸€ì í¬ê¸° ì¤„ì´ê¸° */
        }

        .subcategory a {
            color: black;
            text-decoration: none;
        }

        .subcategory a:hover {
            text-decoration: underline; /* í˜¸ë²„ ì‹œ ë°‘ì¤„ */
        }

        body {
            overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

    </style>

</head>
<body>
<!-- ê³µí†µ í—¤ë” -->
<div th:replace="~{common/header :: header}"></div>

<!-- ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° ì»¨í…Œì´ë„ˆ -->
<div class="container-fluid mt-5 px-0">

    <div class="row">

        <!-- ê³µí†µ ì‚¬ì´ë“œë°” -->
        <div class="col-md-2">
            <div class="sidebar">
                <div th:replace="~{common/sidebar :: sidebar}"></div>
            </div>
        </div>

        <div class="col-md-9">
            <!-- ëª©ë¡, ìˆ˜ì •, ì‚­ì œ ë²„íŠ¼ -->
            <div class="d-flex justify-content-between mb-3">
                <a href="javascript:window.history.back();"
                   class="btn btn-sm btn-outline-secondary">ëª©ë¡</a>
                <div>
                    <a th:if="${user != null and user.nickname == board.nickname}"
                       th:href="@{/board/editBoard/{boardNo}(boardNo=${board.boardNo})}"
                       class="btn btn-sm btn-outline-secondary">ìˆ˜ì •</a>
                    <form th:if="${user != null and user.nickname == board.nickname}"
                          th:action="@{/board/deleteBoard/{boardNo}(boardNo=${board.boardNo})}"
                          method="post"
                          onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                          style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-outline-danger">ì‚­ì œ</button>
                    </form>
                </div>
            </div>
            <!-- êµ¬ë¶„ì„  -->
            <hr>
            <!-- ì¹´í…Œê³ ë¦¬ -->
            <h6>
                <th:block th:each="category : ${boardCategories}">
                    <th:block th:if="${category.key == board.mainCategory}">
                        <th:block th:each="subcategory : ${category.value}">
                <span th:if="${subcategory.name() == board.subCategory}"
                      th:text="${subcategory.subCateName + ' ì¹´í…Œê³ ë¦¬'}">
                </span>
                        </th:block>
                    </th:block>
                </th:block>
            </h6>

            <!-- ê²Œì‹œê¸€ ì œëª© -->
            <h3 th:text="'[' + ${board.tagName} + '] ' + ${board.title}"></h3>

            <!-- ì‘ì„±ì ë° ì‘ì„±ì¼ -->
            <div class="text-muted mb-3">
                <span th:text="${board.nickname}"></span>
                <span th:text="'ì¡°íšŒìˆ˜: ' + ${board.viewCount}" class="ms-3"></span>
                <span th:text="'ëŒ“ê¸€: ' + ${board.commentCount}" class="ms-3"></span>
                <span th:text="${#temporals.format(board.createDate, 'yyyy-MM-dd HH:mm')}" class="ms-3"></span>
            </div>

            <!-- êµ¬ë¶„ì„  -->
            <hr>

            <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
            <div class="mb-4">
                <div th:utext="${board.content}"></div>
            </div>

            <!-- êµ¬ë¶„ì„  -->
            <hr>

            <div class="card-footer">
                <!-- ëŒ“ê¸€ ì œëª© -->
                <h5 id="toggle-comments" style="cursor: pointer; margin-bottom: 1rem; font-size:15px;">
                    ëŒ“ê¸€
                    <a th:if="${board.commentCount > 0}"
                       style="font-size: 11px; color: red; font-weight: bold; margin-left: 5px; mb-1"
                       th:text="${board.commentCount}">
                    </a>
                </h5>

                <!-- ëŒ“ê¸€ ì˜ì—­ -->
                <div id="comment-section">

                    <div class="comment-list mt-3">
                        <div id="comment-template" style="display: none;">
                            <div class="comment-item">

                                <div class="comment-header">
                                    <p><strong class="comment-nickname"></strong>
                                        <span class="comment-date" style="font-size: 0.85rem; color: #666;"></span>
                                    </p>
                                </div>

                                <div class="comment-body">
                                    <div class="comment-image-container mb-1"></div>

                                    <div class="comment-content-row">
                                        <p class="comment-content"></p>
                                        <div class="comment-actions">
                                            <button class="btn btn-sm btn-outline-secondary comment-edit-btn">ìˆ˜ì •
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger comment-delete-btn">ì‚­ì œ</button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                    <form id="commentForm" onsubmit="addComment(event)" enctype="multipart/form-data">
                        <div style="border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-top: 15px;">
                            <div class="form-group">
                                <!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
                                <textarea
                                        id="comment-content"
                                        class="form-control"
                                        name="content"
                                        rows="4"
                                        maxlength="300"
                                        th:placeholder="${user == null} ? 'ë¡œê·¸ì¸ í›„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : 'ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”'"
                                        th:disabled="${user == null}"
                                        required
                                ></textarea>
                            </div>

                            <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                            <img id="preview" class="mt-3 d-none"
                                 style="width: 150px; height: 150px; object-fit: cover;"/>

                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">

                                <!-- ì´ë¯¸ì§€ ì²¨ë¶€ ë²„íŠ¼ -->
                                <div>
                                    <label for="comment-file" class="btn btn-outline-secondary btn-sm me-2"
                                           th:if="${user != null}">
                                        <i class="bi bi-image"></i>
                                    </label>
                                    <input type="file" id="comment-file" name="file" class="form-control d-none"
                                           accept="image/*" onchange="previewImage()">
                                </div>

                                <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 10px;">
                                    <!-- ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸ -->
                                    <div style="font-size: 13px; margin-right: 10px;" class="me-3">
                                        <span id="char-count">0</span>/300
                                    </div>
                                    <!-- ë“±ë¡ ë²„íŠ¼ -->
                                    <button type="submit" class="btn btn-sm btn-dark mb-3" style="font-size: 14px;"
                                            th:if="${user != null}">
                                        ë“±ë¡
                                    </button>
                                </div>
                            </div>

                        </div>
                    </form>
                </div>
            </div>
            <input type="hidden" id="boardNo" th:value="${board.boardNo}"/>
            <input type="hidden" id="loggedInUserNickname" th:value="${user != null ? user.nickname : ''}">

        </div>
    </div>
</div>

<!-- ê³µí†µ í‘¸í„° -->
<div th:replace="~{common/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    // ëŒ“ê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
    function loadComments(boardNo) {
        fetch(`/api/comment/listComment/${boardNo}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
                return response.json(); // JSON ë°ì´í„°ë¥¼ íŒŒì‹±
            })
            .then(comments => {
                console.log("ì„œë²„ì—ì„œ ë°›ì€ ëŒ“ê¸€ ë°ì´í„°:", comments); // ë°ì´í„° í™•ì¸
                renderComments(comments); // ëŒ“ê¸€ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ

            })
            .catch(error => {
                console.error("ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:", error.message);
                alert("ëŒ“ê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // ëŒ“ê¸€ ë°ì´í„°ë¥¼ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
    function renderComments(comments) {
        const commentList = document.querySelector(".comment-list"); // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ì˜ì—­
        const template = document.querySelector("#comment-template"); // ìˆ¨ê²¨ì§„ í…œí”Œë¦¿ ê°€ì ¸ì˜¤ê¸°

        // ëŒ“ê¸€ ì´ˆê¸°í™” (í…œí”Œë¦¿ì€ ìœ ì§€)
          for (const child of commentList.children) {
            if (child !== template) {
                child.remove();
            }
        }
        // ì„œë²„ì—ì„œ ë°›ì€ ëŒ“ê¸€ ë°ì´í„° ë°˜ë³µ ì²˜ë¦¬
        comments.forEach(comment => {
            const clone = template.cloneNode(true); // í…œí”Œë¦¿ ë³µì‚¬
            clone.style.display = "block"; // ìˆ¨ê¹€ í•´ì œ
            clone.setAttribute("data-comment-no", comment.commentNo); // ëŒ“ê¸€ ë²ˆí˜¸ ì„¤ì •

            // ë°ì´í„° ì‚½ì…
            clone.querySelector(".comment-nickname").textContent = comment.nickname;
            clone.querySelector(".comment-date").textContent = formatDate(comment.createDate);
            clone.querySelector(".comment-content").textContent = comment.content;
            // ëŒ“ê¸€ ì´ë¯¸ì§€ ì‚½ì…
            const imageContainer = clone.querySelector(".comment-image-container"); // ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°ˆ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
            if (comment.imageUrl) { // ë§Œì•½ ì´ë¯¸ì§€ê°€ ì¡´ì¬í•˜ë©´?
                const imgTag = document.createElement("img"); // <img> íƒœê·¸ë¥¼ ìƒˆë¡œ ë§Œë“¤ê¸°
                imgTag.src = comment.imageUrl; // ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
                imgTag.alt = "ëŒ“ê¸€ ì´ë¯¸ì§€"; // ì´ë¯¸ì§€ê°€ ì•ˆ ëœ° ë•Œ ëŒ€ì²´ í…ìŠ¤íŠ¸
                imgTag.style.maxWidth = "150px"; // ì´ë¯¸ì§€ í¬ê¸° ì œí•œ
                imageContainer.appendChild(imgTag); // ëŒ“ê¸€ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
            } else { // ë§Œì•½ ì´ë¯¸ì§€ê°€ ì—†ë‹¤ë©´?
                imageContainer.style.display = "none"; // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆë¥¼ ìˆ¨ê¹€ ì²˜ë¦¬
            }

            // ë³¸ì¸ ëŒ“ê¸€ë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë³´ì´ê¸°
            if (comment.nickname === document.getElementById("loggedInUserNickname").value) {
                clone.querySelector(".comment-edit-btn").onclick = () => updateComment(comment.commentNo);
                clone.querySelector(".comment-delete-btn").onclick = () => deleteComment(comment.commentNo);
            } else {
                const actions = clone.querySelector(".comment-actions");
                if (actions) actions.style.display = "none"; // ì‘ì„±ìê°€ ì•„ë‹ˆë©´ ë²„íŠ¼ ìˆ¨ê¹€
            }
            commentList.appendChild(clone); // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
        });
    }

    // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const isToday = date.toDateString() === now.toDateString();

        if (isToday) {
            // ì˜¤ëŠ˜ì¸ ê²½ìš° HH:mm
            return date.toTimeString().slice(0, 5);
        }
        // ì˜¤ëŠ˜ì´ ì•„ë‹Œ ê²½ìš° yy.MM.dd
        return date.toISOString().slice(2, 10).replace(/-/g, ".");
    }

    // ëŒ“ê¸€ì— ì²¨ë¶€ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
    function previewImage() {
        const input = document.getElementById("comment-file");
        const preview = document.getElementById("preview");

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.addEventListener("load", (e) => {
                preview.src = e.target.result;
                preview.classList.remove("d-none");  // ë¯¸ë¦¬ë³´ê¸° ë³´ì´ê²Œ
            });
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.src = "";
            preview.classList.add("d-none");  // ì´ë¯¸ì§€ ì—†ìœ¼ë©´ ìˆ¨ê¸°ê¸°
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ëª©ë¡ ìë™ ë¡œë“œ ë° ëŒ“ê¸€ ì—´ê³  ë‹«ê¸° ë¡œì§ ì¶”ê°€
    document.addEventListener("DOMContentLoaded", () => {

        console.log("DOMContentLoaded ì‹¤í–‰ë¨! í…œí”Œë¦¿ ì¡´ì¬ ì—¬ë¶€:", document.getElementById("comment-template"));
    const templateParent = document.getElementById("comment-template").parentElement;
    console.log("ğŸ“Œ í…œí”Œë¦¿ ë¶€ëª¨ ìš”ì†Œ:", templateParent);

    if (templateParent) {
        console.log("ğŸ“Œ ë¶€ëª¨ ìš”ì†Œ ë‚´ìš© í™•ì¸:", templateParent.innerHTML);
    }
        const boardNo = document.querySelector("#boardNo").value; // ê²Œì‹œê¸€ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        loadComments(boardNo); // ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°

        // ëŒ“ê¸€ ì—´ê³  ë‹«ê¸° ë¡œì§
        const toggleComments = document.getElementById("toggle-comments");
        const commentSection = document.getElementById("comment-section");

        // ì´ˆê¸° ìƒíƒœ (ì—´ë¦¼)
        let isOpen = true;

        // ëŒ“ê¸€ ì—´ê³  ë‹«ê¸° ì´ë²¤íŠ¸
        toggleComments.addEventListener("click", () => {
            isOpen = !isOpen; // ìƒíƒœ ë°˜ì „
            if (isOpen) {
                commentSection.style.display = "block"; // ëŒ“ê¸€ ì—´ê¸°
            } else {
                commentSection.style.display = "none"; // ëŒ“ê¸€ ë‹«ê¸°
            }
        });
    });

    // ëŒ“ê¸€ ë“±ë¡ í•¨ìˆ˜
    function addComment(event) {
        event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€

        // FormData ê°ì²´ ìƒì„±
        const formData = new FormData();
        const content = document.querySelector("textarea[name='content']").value.trim(); // ëŒ“ê¸€ ë‚´ìš©
        const boardNo = document.querySelector("#boardNo").value; // ê²Œì‹œê¸€ ë²ˆí˜¸
        const fileInput = document.querySelector("#comment-file"); // íŒŒì¼ ì¸í’‹

        // ì…ë ¥ ê°’ ê²€ì¦
        if (!content) {
            alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        // FormDataì— ë°ì´í„° ì¶”ê°€
        formData.append("content", content); // ëŒ“ê¸€ ë‚´ìš© ì¶”ê°€
        formData.append("boardNo", boardNo); // ê²Œì‹œê¸€ ë²ˆí˜¸ ì¶”ê°€
        if (fileInput.files.length > 0) {
            formData.append("file", fileInput.files[0]); // íŒŒì¼ ì¶”ê°€
        }

        // ì„œë²„ì— ë°ì´í„° ì „ì†¡
        fetch("/api/comment/addComment", {
            method: "POST",
            body: formData, // FormData ê°ì²´ ì „ì†¡
        })
            .then(response => {
                if (!response.ok) { // ì‘ë‹µ ìƒíƒœ í™•ì¸
                    if (response.status === 401) { // ì¸ì¦ì´ í•„ìš”í•œ ê²½ìš°
                        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        window.location.href = "/user/login"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    }
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
                return response.json(); // JSON ì‘ë‹µ íŒŒì‹±
            })
            .then(data => {
                console.log("addComment ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°:", data);
                updateCommentList(data); // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                clearCommentInput(); // ì…ë ¥ì°½ ì´ˆê¸°í™”
            })
            .catch(error => {
                console.error("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜:", error.message);
                alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

   // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸(ë“±ë¡í•œ ëŒ“ê¸€ì´ ì¶”ê°€ë¨ì„ ë³´ì—¬ì£¼ëŠ” ê²ƒ)
    function updateCommentList(data) {
        console.log("updateCommentList ì‹¤í–‰ë¨!");
        console.log("í…œí”Œë¦¿ ì¡´ì¬ ì—¬ë¶€ (updateCommentList ì‹¤í–‰ ì‹œì ):", document.getElementById("comment-template"));
        console.log("updateCommentList ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data); // ë°ì´í„° í™•ì¸

        const commentList = document.querySelector(".comment-list");
        const template = document.getElementById("comment-template"); // ì›ë³¸ í…œí”Œë¦¿ ê°€ì ¸ì˜¤ê¸°
        console.log("ê°€ì ¸ì˜¨ template:", template); // í…œí”Œë¦¿ ë‚´ìš©ì„ í™•ì¸

        const newComment = template.cloneNode(true); // í…œí”Œë¦¿ ë³µì‚¬
        newComment.style.display = "block"; // ìˆ¨ê²¨ì§„ í…œí”Œë¦¿ í‘œì‹œ
        newComment.setAttribute("data-comment-no", data.commentNo);
        newComment.querySelector(".comment-nickname").textContent = data.nickname || "ìµëª…"; // ë‹‰ë„¤ì„
        newComment.querySelector(".comment-date").textContent = formatDate(data.createDate); // ë‚ ì§œ í¬ë§·
        newComment.querySelector(".comment-content").textContent = data.content || ""; // ëŒ“ê¸€ ë‚´ìš©

        // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
        const loggedInUserNickname = document.getElementById("loggedInUserNickname").value;

        const editButton = newComment.querySelector(".comment-edit-btn");
        const deleteButton = newComment.querySelector(".comment-delete-btn");
        const actions = newComment.querySelector(".comment-actions");

        // ë³¸ì¸ ëŒ“ê¸€ì¸ ê²½ìš° ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë³´ì´ê²Œ ì„¤ì •
        if (data.nickname === loggedInUserNickname) {
            console.log("data nickname í™•ì¸:", data.nickname);
            console.log("loggedInUserNickname í™•ì¸:", loggedInUserNickname);

            // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì„ ë³´ì´ê²Œ ì„¤ì •
            if (actions) actions.style.display = "block";  // ì‘ì„±ì ì¼ì¹˜í•œë‹¤ë©´, ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê²Œ ì„¤ì •

            // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            if (editButton) editButton.onclick = () => updateComment(data.commentNo);
            if (deleteButton) deleteButton.onclick = () => deleteComment(data.commentNo);
        } else {
            // ë³¸ì¸ ëŒ“ê¸€ì´ ì•„ë‹Œ ê²½ìš° ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€ ì²˜ë¦¬
            if (editButton) editButton.style.display = "none"; // ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¹€
            if (deleteButton) deleteButton.style.display = "none"; // ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€
        }

        // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ì— ìƒˆ ëŒ“ê¸€ ì¶”ê°€
        commentList.appendChild(newComment);
        updateCommentCount(1); // ëŒ“ê¸€ì´ ì¶”ê°€ë˜ë©´ ê°œìˆ˜ +1
    }

    // ëŒ“ê¸€ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateCommentCount(change) {
        const commentCountElement = document.querySelector("#toggle-comments a");

        // í˜„ì¬ ëŒ“ê¸€ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
        let currentCount = Number(commentCountElement.textContent) || 0;

        // ëŒ“ê¸€ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        currentCount += change;
        commentCountElement.textContent = currentCount;

        // ëŒ“ê¸€ ê°œìˆ˜ê°€ 0ì´ë©´ ìˆ¨ê¹€ ì²˜ë¦¬
        if (currentCount <= 0) {
            commentCountElement.style.display = "none";
        } else {
            commentCountElement.style.display = "inline"; // ë‹¤ì‹œ ë³´ì´ê²Œ ì„¤ì •
        }
    }

    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    function clearCommentInput() {
        document.querySelector("textarea[name='content']").value = ""; // ì…ë ¥ì°½ ë‚´ìš© ì´ˆê¸°í™”
        document.getElementById("char-count").textContent = "0"; // ê¸€ì ìˆ˜ ì´ˆê¸°í™”

        // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ì´ˆê¸°í™”
        const preview = document.getElementById("preview");
        const input = document.getElementById("comment-file"); // íŒŒì¼ ì„ íƒì°½

        if (preview) {
            preview.src = "";
            preview.classList.add("d-none"); // ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
        }

        if (input) {
            input.value = ""; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
        }
    }

    // ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸ í•¨ìˆ˜
    document.getElementById("comment-content").addEventListener("input", function () {
        const textarea = this;
        const maxLength = 300; // ìµœëŒ€ ê¸€ì ìˆ˜
        const currentLength = textarea.value.length; // í˜„ì¬ ì…ë ¥ëœ ê¸€ì ìˆ˜

        // ê¸€ì ìˆ˜ë¥¼ í™”ë©´ì— í‘œì‹œ
        document.getElementById("char-count").textContent = currentLength;

        // ê¸€ì ì´ˆê³¼ ì‹œ ê²½ê³  (ì„ íƒ ì‚¬í•­)
        if (currentLength > maxLength) {
            alert("ëŒ“ê¸€ì€ 300ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        }
    });

    // ëŒ“ê¸€ ìˆ˜ì •
    function updateComment(commentNo) {
        // ëŒ“ê¸€ ìš”ì†Œë¥¼ ì°¾ê¸°
        const commentElement = document.querySelector(`[data-comment-no='${commentNo}']`);
        if (!commentElement) {
            alert("ëŒ“ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // ê¸°ì¡´ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        const commentContentElement = commentElement.querySelector(".comment-content");
        const originalContent = commentContentElement.textContent;

        // ê¸°ì¡´ ë²„íŠ¼ ê·¸ë£¹ ê°€ì ¸ì˜¤ê¸°
        const buttonGroup = commentElement.querySelector(".comment-actions");

        // ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ í…ìŠ¤íŠ¸ ìƒìë¡œ ë³€ê²½
        const textarea = document.createElement("textarea");
        textarea.value = originalContent;
        textarea.className = "form-control"; // ê¸°ì¡´ form-control ìŠ¤íƒ€ì¼ ì ìš©
        textarea.rows = 2; // ë†’ì´ëŠ” Flexboxì— ë§ê²Œ ì¡°ì •
        textarea.style.flex = "1"; // Flexboxì—ì„œ ë²„íŠ¼ê³¼ ë‚˜ë€íˆ ë°°ì¹˜ë˜ë„ë¡ ì„¤ì •

        // ì €ì¥ ë²„íŠ¼ ìƒì„±
        const saveButton = document.createElement("button");
        saveButton.textContent = "ì €ì¥";
        saveButton.className = "btn btn-sm btn-outline-secondary";

        // ì·¨ì†Œ ë²„íŠ¼ ìƒì„±
        const cancelButton = document.createElement("button");
        cancelButton.textContent = "ì·¨ì†Œ";
        cancelButton.className = "btn btn-sm btn-outline-danger";

        // UI ë³µêµ¬ í•¨ìˆ˜
        function restoreOriginalUI() {
            textarea.remove();
            saveButton.remove();
            cancelButton.remove();
            commentContentElement.style.display = "block";
            buttonGroup.style.display = "flex";
        }

        // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        saveButton.onclick = () => {
            const updatedContent = textarea.value.trim();

            if (!updatedContent) {
                alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            // ì„œë²„ì— PUT ìš”ì²­ ë³´ë‚´ê¸°
            fetch(`/api/comment/updateComment/${commentNo}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    commentNo: commentNo, // ëŒ“ê¸€ ë²ˆí˜¸ ì¶”ê°€
                    content: updatedContent, // ìˆ˜ì •ëœ ëŒ“ê¸€ ë‚´ìš©
                }),
            })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().then((errorData) => {
                            throw new Error(errorData.message || "ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        });
                    }
                    return response.json();
                })
                .then((updatedComment) => {
                    // ì„œë²„ ì‘ë‹µì— ë”°ë¼ UI ì—…ë°ì´íŠ¸
                    commentContentElement.textContent = updatedComment.content;
                    restoreOriginalUI();
                })
                .catch((error) => {
                    alert("ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
                });
        };

        // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        cancelButton.onclick = () => {
            restoreOriginalUI(); // UI ë³µêµ¬
        };

        // ê¸°ì¡´ í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
        commentContentElement.style.display = "none";

        // ê¸°ì¡´ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        buttonGroup.style.display = "none";

        // Flexbox êµ¬ì¡°ë¡œ ìˆ˜ì • UI ì¶”ê°€
        const editRow = document.createElement("div");
        editRow.className = "comment-content-row"; // ê¸°ì¡´ ë ˆì´ì•„ì›ƒ í´ë˜ìŠ¤

        // textareaì™€ ë²„íŠ¼ ì¶”ê°€
        editRow.appendChild(textarea);

        const actions = document.createElement("div");
        actions.className = "comment-actions"; // ë²„íŠ¼ ë ˆì´ì•„ì›ƒ í´ë˜ìŠ¤
        actions.appendChild(saveButton);
        actions.appendChild(cancelButton);
        editRow.appendChild(actions);

        // ëŒ“ê¸€ ìš”ì†Œì— ì¶”ê°€
        commentElement.appendChild(editRow);
    }

    // ëŒ“ê¸€ ì‚­ì œ
    function deleteComment(commentNo) {
        // ì‚­ì œ í™•ì¸ ë©”ì‹œì§€
        const confirmDelete = confirm("ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if (!confirmDelete) {
            return;
        }

        // ì„œë²„ì— DELETE ìš”ì²­ ë³´ë‚´ê¸°
        fetch(`/api/comment/deleteComment/${commentNo}`, {
            method: "DELETE",
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                return response.text();
            })
            .then((message) => {
                // í™”ë©´ì—ì„œ ëŒ“ê¸€ ì‚­ì œ
                const commentElement = document.querySelector(`[data-comment-no="${commentNo}"]`);
                if (commentElement) {
                    commentElement.remove();

                    updateCommentCount(-1); // ëŒ“ê¸€ ê°œìˆ˜ ë™ê¸°í™”

                }
            })
            .catch((error) => {
                alert("ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            });
    }

</script>

</body>
</html>